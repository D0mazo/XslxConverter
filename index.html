<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8">
  <title>Excel to TXT Splitter</title>

  <link rel="stylesheet" type="text/css" href="style.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>

<body>
  <h1>
    Įkelti xlsx failą, D – informacija,
    E – sandėlys iš kurio,
    F – sandėlys į kurį
  </h1>

  <form id="uploadForm">
    <input type="file" id="fileInput" accept=".xlsx" required>
    <br><br>
    <button type="submit">Konvertuoti</button>
  </form>

  <div id="status"></div>

  <script>
    document.getElementById('uploadForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const file = document.getElementById('fileInput').files[0];
      const status = document.getElementById('status');

      if (!file) {
        status.textContent = 'Failas neįkeltas';
        return;
      }

      const reader = new FileReader();

      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const values_d = rows.map(r => r[3]); // D
        const values_e = rows.map(r => r[4]); // E
        const values_f = rows.map(r => r[5]); // F

        const max_chunk_size = 199;
        const zip = new JSZip();
        let i = 0;

        while (i < values_d.length) {
          const current_e = values_e[i];
          const current_f = values_f[i];
          let chunk = [];
          let file_count = 1;

          while (
            i < values_d.length &&
            values_e[i] === current_e &&
            values_f[i] === current_f
          ) {
            if (values_d[i] !== undefined) {
              chunk.push(values_d[i]);
            }
            i++;

            if (chunk.length === max_chunk_size) {
              zip.file(
                `${current_e}_${current_f}_${file_count}.txt`,
                chunk.join('\n')
              );
              file_count++;
              chunk = [];
            }
          }

          if (chunk.length > 0) {
            zip.file(
              `${current_e}_${current_f}_${file_count}.txt`,
              chunk.join('\n')
            );
          }
        }

        zip.generateAsync({ type: 'blob' }).then(content => {
          saveAs(content, 'txt.zip');
          status.textContent = 'Operacija sėkminga';
        });
      };

      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
