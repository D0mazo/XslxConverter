<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8">
  <title>Excel to TXT Splitter</title>

  <link rel="stylesheet" type="text/css" href="style.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>

<body>
<h1>
  Ä®kelti xlsx failÄ…, A - Kodas,
  D â€“ informacija,
  E â€“ sandÄ—lys iÅ¡ kurio,
  F â€“ sandÄ—lys Ä¯ kurÄ¯
</h1>

<form id="uploadForm">
  <input type="file" id="fileInput" accept=".xlsx" required>
  <br><br>
  <button type="submit">Konvertuoti</button>
</form>

<div id="status"></div>

<script>
document.getElementById('uploadForm').addEventListener('submit', function (e) {
  e.preventDefault();

  const file = document.getElementById('fileInput').files[0];
  const status = document.getElementById('status');

  if (!file) {
    status.textContent = 'Failas neÄ¯keltas';
    return;
  }

  status.textContent = 'Skaitomas Excel failas...';

  const reader = new FileReader();

  reader.onload = function (evt) {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: 'array' });

    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];

    /* ğŸ”¥ FORCE FULL RANGE (FIX 1000 ROW LIMIT) */
    const range = XLSX.utils.decode_range(sheet['!ref']);
    range.e.r = Math.max(range.e.r, 200000); // allow up to 200k rows
    sheet['!ref'] = XLSX.utils.encode_range(range);

    const rows = XLSX.utils.sheet_to_json(sheet, {
      header: 1,
      defval: '',
      blankrows: false
    });

    console.log('TOTAL ROWS READ:', rows.length);

    const zip = new JSZip();
    const MAX_LINES = 199;

    let currentKey = null;
    let buffer = [];
    let fileIndex = 1;

    /* skip header row -> start from index 1 */
    for (let i = 1; i < rows.length; i++) {
      const row = rows[i];
      if (!row) continue;

      const d = String(row[3] || '').trim(); // D
      const e = String(row[4] || '').trim(); // E
      const f = String(row[5] || '').trim(); // F

      if (!d || !e || !f) continue;

      const key = `${e}_${f}`;

      if (currentKey !== key) {
        if (buffer.length > 0) {
          zip.file(`${currentKey}_${fileIndex}.txt`, buffer.join('\n'));
          buffer = [];
          fileIndex = 1;
        }
        currentKey = key;
      }

      buffer.push(d);

      if (buffer.length === MAX_LINES) {
        zip.file(`${currentKey}_${fileIndex}.txt`, buffer.join('\n'));
        buffer = [];
        fileIndex++;
      }
    }

    if (buffer.length > 0 && currentKey) {
      zip.file(`${currentKey}_${fileIndex}.txt`, buffer.join('\n'));
    }

    zip.generateAsync({ type: 'blob' }).then(blob => {
      saveAs(blob, 'txt.zip');
      status.textContent = 'âœ… Operacija sÄ—kminga (15k+ eiluÄiÅ³ palaikoma)';
    });
  };

  reader.readAsArrayBuffer(file);
});
</script>
</body>
</html>
